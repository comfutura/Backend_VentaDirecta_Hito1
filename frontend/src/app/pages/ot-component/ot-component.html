<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-11 col-xl-10">
      <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div class="card-header bg-gradient-primary text-white py-4">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="bi bi-file-earmark-plus-fill fs-3 me-3"></i>
              <h4 class="mb-0">Crear Orden de Trabajo Completa</h4>
            </div>
            <small class="opacity-75">
              Creado por: {{ usernameLogueado }}
              <span class="ms-2 text-white-50" *ngIf="trabajadorIdLogueado">(ID: {{ trabajadorIdLogueado }})</span>
            </small>
          </div>
        </div>

        <div class="card-body p-4 p-md-5">
          <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>

            <!-- Información principal -->
            <h5 class="mb-4 pb-2 border-bottom text-primary">
              <i class="bi bi-info-circle me-2"></i> Información principal de la OT
            </h5>

            <div class="row g-4 mb-5">
              <div class="col-md-6">
                <label class="form-label fw-bold">Cliente <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idCliente"
                        [class.is-invalid]="submitted && f['idCliente'].invalid">
                  <option value="">Seleccione cliente...</option>
                  <option *ngFor="let c of clientes" [value]="c.id">{{ c.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">Área <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idArea"
                        [disabled]="!f['idCliente'].value || areas.length === 0"
                        [class.is-invalid]="submitted && f['idArea'].invalid">
                  <option value="">Seleccione área...</option>
                  <option *ngFor="let a of areas" [value]="a.id">{{ a.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
                <small class="form-text text-muted" *ngIf="!f['idCliente'].value">
                  Selecciona un cliente primero
                </small>
              </div>
            </div>

            <div class="row g-4 mb-5">
              <div class="col-md-6">
                <label class="form-label fw-bold">Proyecto <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idProyecto"
                        [class.is-invalid]="submitted && f['idProyecto'].invalid">
                  <option value="">Seleccione proyecto...</option>
                  <option *ngFor="let p of proyectos" [value]="p.id">{{ p.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">Fase <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idFase"
                        [class.is-invalid]="submitted && f['idFase'].invalid">
                  <option value="">Seleccione fase...</option>
                  <option *ngFor="let f of fases" [value]="f.id">{{ f.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
              </div>
            </div>

            <div class="row g-4 mb-5">
              <div class="col-md-6">
                <label class="form-label fw-bold">Site <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idSite"
                        [class.is-invalid]="submitted && f['idSite'].invalid">
                  <option value="">Seleccione site...</option>
                  <option *ngFor="let s of sites" [value]="s.id">{{ s.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">Región <span class="text-danger">*</span></label>
                <select class="form-select form-control-lg" formControlName="idRegion"
                        [class.is-invalid]="submitted && f['idRegion'].invalid">
                  <option value="">Seleccione región...</option>
                  <option *ngFor="let r of regiones" [value]="r.id">{{ r.label }}</option>
                </select>
                <div class="invalid-feedback">Obligatorio</div>
              </div>
            </div>

            <!-- Descripción auto-generada -->
            <div class="mb-5">
              <label class="form-label fw-bold">Descripción / Observaciones <span class="text-danger">*</span></label>
              <textarea class="form-control bg-light" formControlName="descripcion" rows="3" readonly></textarea>
              <small class="form-text text-muted mt-1">
                Generada automáticamente: Proyecto - Área - ID Site - Nombre Site
              </small>
            </div>

            <!-- Fecha Apertura -->
            <div class="mb-5">
              <label class="form-label fw-bold">Fecha de Apertura <span class="text-danger">*</span></label>
              <input type="date" class="form-control form-control-lg" formControlName="fechaApertura"
                     [class.is-invalid]="submitted && f['fechaApertura'].invalid">
              <div class="invalid-feedback">Obligatoria</div>
            </div>
<!-- Responsables con dropdowns -->
<h5 class="mb-4 pb-2 border-bottom text-primary">
  <i class="bi bi-person-badge-fill me-2"></i> Responsables y Jefaturas
</h5>

<div class="row g-4 mb-5">
  <div class="col-md-6">
    <label class="form-label">Jefatura Cliente Solicitante</label>
    <select class="form-select" formControlName="idJefaturaClienteSolicitante">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let j of jefaturasCliente" [value]="j.id">{{ j.label }}</option>
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label">Analista Cliente Solicitante</label>
    <select class="form-select" formControlName="idAnalistaClienteSolicitante">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let a of analistasCliente" [value]="a.id">{{ a.label }}</option>
    </select>
  </div>
</div>

<div class="mb-5">
  <label class="form-label">Coordinadores TI / CW / PEXT / Energía</label>
  <input type="text" class="form-control" formControlName="coordinadoresTiCwPextEnergia"
         placeholder="Ej: Coord. Eduardo Silva, Coord. Patricia López">
  <small class="form-text text-muted">
    Nombres separados por coma (texto libre para múltiples)
  </small>
</div>

<div class="row g-4 mb-5">
  <div class="col-md-3">
    <label class="form-label">Jefatura Responsable</label>
    <select class="form-select" formControlName="idJefaturaResponsable">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let j of jefaturasResponsable" [value]="j.id">{{ j.label }}</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Liquidador</label>
    <select class="form-select" formControlName="idLiquidador">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let l of liquidadores" [value]="l.id">{{ l.label }}</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Ejecutante</label>
    <select class="form-select" formControlName="idEjecutante">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let e of ejecutantes" [value]="e.id">{{ e.label }}</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Analista Contable</label>
    <select class="form-select" formControlName="idAnalistaContable">
      <option value="">-- Seleccionar --</option>
      <option *ngFor="let a of analistasContable" [value]="a.id">{{ a.label }}</option>
    </select>
  </div>
</div>

            <!-- Botones finales -->
            <div class="d-flex gap-3 justify-content-end mt-5 pt-4 border-top">
              <button type="button" class="btn btn-outline-secondary btn-lg px-5" (click)="resetForm()" [disabled]="loading">
                <i class="bi bi-arrow-counterclockwise me-2"></i> Limpiar
              </button>

              <button type="submit" class="btn btn-primary btn-lg px-5" [disabled]="loading || form.invalid">
                <ng-container *ngIf="!loading">
                  <i class="bi bi-check2-circle me-2"></i> Crear OT Completa
                </ng-container>
                <ng-container *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Procesando...
                </ng-container>
              </button>
            </div>
          </form>
        </div>

        <div class="card-footer bg-light text-muted small text-center py-3">
          Campos con <span class="text-danger">*</span> son obligatorios • El número OT se genera automáticamente
        </div>
      </div>
    </div>
  </div>
</div>
