<div class="container-fluid py-4">
  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="fas fa-users me-2"></i>Gestión de Usuarios
    </h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="fas fa-plus me-2"></i>Nuevo Usuario
    </button>
  </div>

  <!-- Filtros -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
      </h6>
      <button class="btn btn-sm btn-link" (click)="showFilters = !showFilters">
        <i class="fas" [class.fa-chevron-down]="!showFilters" [class.fa-chevron-up]="showFilters"></i>
      </button>
    </div>
    <div class="card-body" *ngIf="showFilters">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Buscar</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control"
                   [(ngModel)]="searchTerm"
                   placeholder="Buscar por username o nombre...">
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Estado</label>
          <select class="form-select" [(ngModel)]="filtroActivo">
            <option [ngValue]="null">Todos</option>
            <option [ngValue]="true">Activos</option>
            <option [ngValue]="false">Inactivos</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Nivel</label>
          <select class="form-select" [(ngModel)]="filtroNivelId">
            <option [ngValue]="null">Todos los niveles</option>
            <option *ngFor="let nivel of niveles" [value]="nivel.idNivel">
              {{ nivel.nombre }}
            </option>
          </select>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <div class="d-flex gap-2">
            <button class="btn btn-primary" (click)="aplicarFiltros()">
              <i class="fas fa-search me-1"></i>Buscar
            </button>
            <button class="btn btn-outline-secondary" (click)="limpiarFiltros()">
              <i class="fas fa-eraser me-1"></i>Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de usuarios -->
  <div class="card shadow">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Lista de Usuarios</h6>
    </div>

    <div class="card-body">
      <!-- Loading -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando usuarios...</p>
      </div>

      <!-- Tabla -->
      <div *ngIf="!isLoading">
        <div class="table-responsive">
          <table class="table table-hover table-striped">
            <thead class="table-light">
              <tr>
                <th (click)="sort('idUsuario')" style="cursor: pointer; width: 80px;">
                  ID
                  <i *ngIf="sortBy === 'idUsuario'"
                     class="fas"
                     [class.fa-sort-up]="sortDirection === 'asc'"
                     [class.fa-sort-down]="sortDirection === 'desc'"></i>
                </th>
                <th (click)="sort('username')" style="cursor: pointer;">
                  Username
                  <i *ngIf="sortBy === 'username'"
                     class="fas"
                     [class.fa-sort-up]="sortDirection === 'asc'"
                     [class.fa-sort-down]="sortDirection === 'desc'"></i>
                </th>
                <th>Trabajador</th>
                <th>Nivel</th>
                <th (click)="sort('activo')" style="cursor: pointer;">
                  Estado
                  <i *ngIf="sortBy === 'activo'"
                     class="fas"
                     [class.fa-sort-up]="sortDirection === 'asc'"
                     [class.fa-sort-down]="sortDirection === 'desc'"></i>
                </th>
                <th>Fecha Creación</th>
                <th class="text-center" style="width: 150px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let usuario of usuarios">
                <td class="fw-bold">{{ usuario.idUsuario }}</td>
                <td>
                  <i class="fas fa-user me-2"></i>
                  <strong>{{ usuario.username }}</strong>
                </td>
                <td>{{ getTrabajadorNombre(usuario) }}</td>
                <td>
                  <span class="badge bg-info">
                    {{ usuario.nivelNombre || 'N/A' }}
                  </span>
                </td>
                <td>
                  <span [class]="getEstadoClass(usuario.activo)">
                    {{ getEstadoText(usuario.activo) }}
                  </span>
                </td>
                <td>
                  {{ usuario.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary"
                            [title]="usuario.activo ? 'Desactivar' : 'Activar'"
                            (click)="toggleActivo(usuario)">
                      <i class="fas" [class.fa-toggle-on]="usuario.activo" [class.fa-toggle-off]="!usuario.activo"></i>
                    </button>

                    <button class="btn btn-outline-info"
                            title="Cambiar contraseña"
                            (click)="cambiarPassword(usuario)">
                      <i class="fas fa-key"></i>
                    </button>

                    <button class="btn btn-outline-warning"
                            title="Editar"
                            (click)="openEditModal(usuario)">
                      <i class="fas fa-edit"></i>
                    </button>

                    <button class="btn btn-outline-danger"
                            title="Eliminar"
                            (click)="deleteUsuario(usuario)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>

              <tr *ngIf="usuarios.length === 0 && !isLoading">
                <td colspan="7" class="text-center py-4">
                  <div class="text-muted">
                    <i class="fas fa-user-slash fa-2x mb-3"></i>
                    <p class="mb-0">No se encontraron usuarios</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="d-flex justify-content-between align-items-center mt-4">
          <div class="text-muted">
            Mostrando {{ usuarios.length }} de {{ totalItems }} registros
          </div>

          <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center">
              <label class="me-2">Mostrar:</label>
              <select class="form-select form-select-sm" style="width: auto;"
                      [(ngModel)]="pageSize"
                      (change)="changePageSize(pageSize)">
                <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
              </select>
            </div>

            <nav aria-label="Page navigation">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="currentPage === 0">
                  <button class="page-link" (click)="changePage(currentPage - 1)">
                    <i class="fas fa-chevron-left"></i>
                  </button>
                </li>

                <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
                    [class.active]="i === currentPage">
                  <button class="page-link" (click)="changePage(i)">
                    {{ i + 1 }}
                  </button>
                </li>

                <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
                  <button class="page-link" (click)="changePage(currentPage + 1)">
                    <i class="fas fa-chevron-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div class="modal fade show" [class.d-block]="showModal" tabindex="-1" role="dialog"
     [class.show]="showModal" *ngIf="showModal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas" [class.fa-user-plus]="modalMode === 'create'"
             [class.fa-user-edit]="modalMode === 'edit'"></i>
          {{ modalTitle }}
        </h5>
        <button type="button" class="btn-close btn-close-white"
                (click)="closeModal()"></button>
      </div>

      <div class="modal-body">
        <form #usuarioForm="ngForm">
          <div class="row g-3">
            <!-- Username -->
            <div class="col-md-6">
              <label class="form-label required">Username</label>
              <input type="text" class="form-control"
                     [(ngModel)]="usuarioFormData.username"
                     name="username"
                     required
                     placeholder="Ej: jperez">
              <small class="form-text text-muted">Nombre de usuario para acceder al sistema</small>
            </div>

            <!-- Trabajador -->
            <div class="col-md-6">
              <label class="form-label required">Trabajador</label>
              <select class="form-select"
                      [(ngModel)]="usuarioFormData.trabajadorId"
                      name="trabajadorId"
                      required>
                <option [ngValue]="null" disabled>Seleccione un trabajador</option>
                <option *ngFor="let trabajador of trabajadores"
                        [value]="trabajador.idTrabajador">
                  {{ trabajador.nombreCompleto }}
                </option>
              </select>
            </div>

            <!-- Nivel -->
            <div class="col-md-6">
              <label class="form-label required">Nivel de Acceso</label>
              <select class="form-select"
                      [(ngModel)]="usuarioFormData.nivelId"
                      name="nivelId"
                      required>
                <option [ngValue]="null" disabled>Seleccione un nivel</option>
                <option *ngFor="let nivel of niveles" [value]="nivel.idNivel">
                  {{ nivel.nombre }} ({{ nivel.codigo }})
                </option>
              </select>
            </div>

            <!-- Contraseña (solo para crear) -->
            <div class="col-md-6" *ngIf="modalMode === 'create'">
              <label class="form-label required">Contraseña</label>
              <input type="password" class="form-control"
                     [(ngModel)]="usuarioFormData.password"
                     name="password"
                     required
                     placeholder="Mínimo 6 caracteres">
            </div>

            <!-- Confirmar Contraseña (solo para crear) -->
            <div class="col-md-6" *ngIf="modalMode === 'create'">
              <label class="form-label required">Confirmar Contraseña</label>
              <input type="password" class="form-control"
                     [(ngModel)]="usuarioFormData.confirmPassword"
                     name="confirmPassword"
                     required
                     placeholder="Repita la contraseña">
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          <i class="fas fa-times me-1"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="saveUsuario()">
          <i class="fas fa-save me-1"></i>
          {{ modalMode === 'create' ? 'Crear Usuario' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay para modal -->
<div class="modal-backdrop fade show" *ngIf="showModal"></div>
