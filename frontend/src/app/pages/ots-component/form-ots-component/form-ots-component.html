<div class="form-ots-container bg-white min-vh-100">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-overlay d-flex align-items-center justify-content-center">
    <div class="text-center">
      <div class="spinner-grow text-primary" style="width: 3.5rem; height: 3.5rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <h5 class="mt-4 text-primary fw-semibold">
        {{ isEditMode ? 'Cargando datos de la OT...' : 'Cargando formulario...' }}
      </h5>
    </div>
  </div>

  <!-- Formulario principal -->
  <ng-container *ngIf="!loading">
    <div class="form-header bg-primary text-white p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center gap-3">
          <div class="header-icon bg-white text-primary rounded-circle p-3 shadow-sm">
            <i class="bi bi-file-earmark-text fs-2"></i>
          </div>
          <div>
            <h3 class="mb-1 fw-bold">
              {{ isEditMode ? 'Editar Orden de Trabajo' : 'Nueva Orden de Trabajo' }}
              <span *ngIf="isEditMode && form.value.idOts" class="badge bg-light text-primary ms-2 fs-6">
                #{{ form.value.idOts }}
              </span>
            </h3>
            <p class="mb-0 opacity-75">
              {{ isEditMode ? 'Modifique los datos necesarios' : 'Complete todos los campos obligatorios' }}
            </p>
          </div>
        </div>

        <!-- Botón cerrar -->
        <button type="button" class="btn-close btn-close-white opacity-75"
                (click)="onCancel()" aria-label="Cerrar">
        </button>
      </div>

      <!-- Usuario logueado -->
      <div class="user-info small bg-primary-dark rounded-pill px-3 py-1 d-inline-flex align-items-center gap-2">
        <i class="bi bi-person-circle"></i>
        <span>{{ usernameLogueado }}</span>
        <span *ngIf="trabajadorIdLogueado" class="opacity-75">
          (ID: {{ trabajadorIdLogueado }})
        </span>
      </div>
    </div>

    <!-- Steps Navigation -->
    <div class="steps-navigation bg-light px-4 py-3 border-bottom">
      <div class="d-flex justify-content-center gap-2">
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 1"
                [class.completed]="currentStep > 1"
                (click)="cambiarPaso(1)">
          <i class="bi bi-1-circle me-2"></i>
          Información Principal
        </button>
        <div class="step-divider d-flex align-items-center px-2">
          <i class="bi bi-chevron-right text-muted"></i>
        </div>
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 2"
                [class.completed]="currentStep > 2"
                (click)="cambiarPaso(2)">
          <i class="bi bi-2-circle me-2"></i>
          Responsables
        </button>
        <div class="step-divider d-flex align-items-center px-2">
          <i class="bi bi-chevron-right text-muted"></i>
        </div>
        <button type="button" class="step-btn rounded-pill px-4 py-2 border-0 fw-medium"
                [class.active]="currentStep === 3"
                (click)="cambiarPaso(3)">
          <i class="bi bi-3-circle me-2"></i>
          Confirmar
        </button>
      </div>
    </div>

    <!-- Contenido del formulario con scroll -->
    <div class="form-content-scrollable" #scrollContainer>
      <div class="p-4">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
          <!-- Paso 1: Información Principal -->
          <div *ngIf="currentStep === 1" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-card-checklist text-primary me-2"></i>
              Información Principal de la OT
              <span class="badge bg-primary-subtle text-primary ms-2 fs-7">Todos obligatorios</span>
            </h5>

            <div class="row g-4">
              <!-- Cliente -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Cliente <span class="text-danger">*</span>
                  </label>
                  <select class="form-select form-select-lg" formControlName="idCliente"
                          [class.is-invalid]="submitted && f['idCliente'].invalid">
                    <option [ngValue]="null">Seleccione un cliente...</option>
                    <option *ngFor="let c of clientes" [ngValue]="c.id">
                      {{ c.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idCliente'].invalid" class="invalid-feedback">
                    Debe seleccionar un cliente
                  </div>
                </div>
              </div>

              <!-- Área -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Área <span class="text-danger">*</span>
                  </label>
                  <select class="form-select form-select-lg" formControlName="idArea"
                          [class.is-invalid]="submitted && f['idArea'].invalid"
                          [disabled]="!f['idCliente'].value">
                    <option [ngValue]="null">
                      {{ f['idCliente'].value ? 'Seleccione área...' : 'Seleccione cliente primero' }}
                    </option>
                    <option *ngFor="let a of areas" [ngValue]="a.id">
                      {{ a.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idArea'].invalid" class="invalid-feedback">
                    Debe seleccionar un área
                  </div>
                </div>
              </div>

              <!-- Fecha Apertura -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Fecha de Apertura <span class="text-danger">*</span>
                  </label>
                  <input type="date" class="form-control form-control-lg" formControlName="fechaApertura"
                         [class.is-invalid]="submitted && f['fechaApertura'].invalid">
                  <div *ngIf="submitted && f['fechaApertura'].invalid" class="invalid-feedback">
                    Fecha requerida
                  </div>
                </div>
              </div>

              <!-- Proyecto -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Proyecto <span class="text-danger">*</span>
                  </label>
                  <select class="form-select form-select-lg" formControlName="idProyecto"
                          [class.is-invalid]="submitted && f['idProyecto'].invalid">
                    <option [ngValue]="null">Seleccione proyecto...</option>
                    <option *ngFor="let p of proyectos" [ngValue]="p.id">
                      {{ p.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idProyecto'].invalid" class="invalid-feedback">
                    Debe seleccionar un proyecto
                  </div>
                </div>
              </div>

              <!-- Fase -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Fase <span class="text-danger">*</span>
                  </label>
                  <select class="form-select form-select-lg" formControlName="idFase"
                          [class.is-invalid]="submitted && f['idFase'].invalid">
                    <option [ngValue]="null">Seleccione fase...</option>
                    <option *ngFor="let f of fases" [ngValue]="f.id">
                      {{ f.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idFase'].invalid" class="invalid-feedback">
                    Debe seleccionar una fase
                  </div>
                </div>
              </div>

           <!-- Site -->
<div class="col-md-6">
  <div class="form-group">
    <label class="form-label fw-medium">
      Site <span class="text-danger">*</span>
    </label>

    <select
      class="form-select form-select-lg"
      formControlName="idSite"
      [class.is-invalid]="submitted && f['idSite']?.invalid">

      <option [ngValue]="null">Seleccione site...</option>

      <option *ngFor="let s of sites" [ngValue]="s.id">
        {{ s.label }} - {{ s.adicional || 'SIN DESCRIPCIÓN' }}
      </option>

    </select>

    <div *ngIf="submitted && f['idSite']?.invalid" class="invalid-feedback">
      Debe seleccionar un site
    </div>
  </div>
</div>


              <!-- Región -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Región <span class="text-danger">*</span>
                  </label>
                  <select class="form-select form-select-lg" formControlName="idRegion"
                          [class.is-invalid]="submitted && f['idRegion'].invalid">
                    <option [ngValue]="null">Seleccione región...</option>
                    <option *ngFor="let r of regiones" [ngValue]="r.id">
                      {{ r.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idRegion'].invalid" class="invalid-feedback">
                    Debe seleccionar una región
                  </div>
                </div>
              </div>

              <!-- OT Anterior -->
              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    OT Anterior
                    <span class="badge bg-secondary-subtle text-secondary ms-1 fs-7">Opcional</span>
                  </label>
                  <input type="number" class="form-control form-control-lg" formControlName="idOtsAnterior"
                         min="1" placeholder="Número de OT anterior">
                  <small class="form-text text-muted">
                    Número de OT previa si aplica (único campo opcional)
                  </small>
                </div>
              </div>

              <!-- Descripción -->
              <div class="col-12">
                <div class="form-group">
                  <label class="form-label fw-medium">
                    Descripción <span class="text-danger">*</span>
                    <span *ngIf="!isEditMode" class="badge bg-info-subtle text-info ms-1 fs-7">Auto-generada</span>
                  </label>
                  <textarea class="form-control" formControlName="descripcion" rows="3"
                            [readonly]="!isEditMode"
                            [class.bg-light]="!isEditMode"
                            placeholder="Descripción automática según selección..."></textarea>
                  <div *ngIf="submitted && f['descripcion'].invalid" class="invalid-feedback d-block">
                    La descripción es requerida
                  </div>
                  <small *ngIf="!isEditMode" class="form-text text-info">
                    <i class="bi bi-info-circle me-1"></i>
                    La descripción se genera automáticamente según las selecciones realizadas
                  </small>
                </div>
              </div>
            </div>

            <!-- Botones paso 1 -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-danger btn-lg px-4"
                        (click)="resetForm()" [disabled]="loading">
                  <i class="bi bi-x-circle me-2"></i>
                  {{ isEditMode ? 'Cancelar' : 'Limpiar' }}
                </button>
                <button type="button" class="btn btn-primary btn-lg px-5"
                        (click)="cambiarPaso(2)"
                        [disabled]="form.invalid || loading">
                  Continuar
                  <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Paso 2: Responsables -->
          <div *ngIf="currentStep === 2" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-person-badge text-primary me-2"></i>
              Responsables y Contactos
              <span class="badge bg-primary-subtle text-primary ms-2 fs-7">Todos obligatorios</span>
            </h5>

            <div class="alert alert-info border-0 bg-info-subtle mb-4">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Todos los siguientes campos son obligatorios.</strong> Debe asignar todos los responsables para continuar.
            </div>

            <div class="row g-4">
              <!-- Columna Izquierda -->
              <div class="col-md-6">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-building me-2"></i>
                  Cliente Solicitante
                </h6>

                <!-- Jefatura Cliente -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Jefatura Cliente <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idJefaturaClienteSolicitante"
                          [class.is-invalid]="submitted && f['idJefaturaClienteSolicitante'].invalid">
                    <option [ngValue]="null">-- Seleccione jefatura --</option>
                    <option *ngFor="let j of jefaturasCliente" [ngValue]="j.id">
                      {{ j.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idJefaturaClienteSolicitante'].invalid" class="invalid-feedback">
                    Debe seleccionar una jefatura cliente
                  </div>
                </div>

                <!-- Analista Cliente -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Analista Cliente <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idAnalistaClienteSolicitante"
                          [class.is-invalid]="submitted && f['idAnalistaClienteSolicitante'].invalid">
                    <option [ngValue]="null">-- Seleccione analista --</option>
                    <option *ngFor="let a of analistasCliente" [ngValue]="a.id">
                      {{ a.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idAnalistaClienteSolicitante'].invalid" class="invalid-feedback">
                    Debe seleccionar un analista cliente
                  </div>
                </div>

                <!-- Coordinador TI/CW -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Coordinador TI/CW <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idCoordinadorTiCw"
                          [class.is-invalid]="submitted && f['idCoordinadorTiCw'].invalid">
                    <option [ngValue]="null">-- Seleccione coordinador --</option>
                    <option *ngFor="let c of coordinadoresTiCw" [ngValue]="c.id">
                      {{ c.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idCoordinadorTiCw'].invalid" class="invalid-feedback">
                    Debe seleccionar un coordinador TI/CW
                  </div>
                </div>
              </div>

              <!-- Columna Derecha -->
              <div class="col-md-6">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-person-gear me-2"></i>
                  Responsables Internos
                </h6>

                <!-- Jefatura Responsable -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Jefatura Responsable <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idJefaturaResponsable"
                          [class.is-invalid]="submitted && f['idJefaturaResponsable'].invalid">
                    <option [ngValue]="null">-- Seleccione jefatura --</option>
                    <option *ngFor="let j of jefaturasResponsable" [ngValue]="j.id">
                      {{ j.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idJefaturaResponsable'].invalid" class="invalid-feedback">
                    Debe seleccionar una jefatura responsable
                  </div>
                </div>

                <!-- Liquidador -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Liquidador <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idLiquidador"
                          [class.is-invalid]="submitted && f['idLiquidador'].invalid">
                    <option [ngValue]="null">-- Seleccione liquidador --</option>
                    <option *ngFor="let l of liquidadores" [ngValue]="l.id">
                      {{ l.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idLiquidador'].invalid" class="invalid-feedback">
                    Debe seleccionar un liquidador
                  </div>
                </div>

                <!-- Ejecutante -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Ejecutante <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idEjecutante"
                          [class.is-invalid]="submitted && f['idEjecutante'].invalid">
                    <option [ngValue]="null">-- Seleccione ejecutante --</option>
                    <option *ngFor="let e of ejecutantes" [ngValue]="e.id">
                      {{ e.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idEjecutante'].invalid" class="invalid-feedback">
                    Debe seleccionar un ejecutante
                  </div>
                </div>

                <!-- Analista Contable -->
                <div class="form-group mb-4">
                  <label class="form-label fw-medium">
                    Analista Contable <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="idAnalistaContable"
                          [class.is-invalid]="submitted && f['idAnalistaContable'].invalid">
                    <option [ngValue]="null">-- Seleccione analista --</option>
                    <option *ngFor="let a of analistasContable" [ngValue]="a.id">
                      {{ a.label }}
                    </option>
                  </select>
                  <div *ngIf="submitted && f['idAnalistaContable'].invalid" class="invalid-feedback">
                    Debe seleccionar un analista contable
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones paso 2 -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary btn-lg px-4"
                        (click)="cambiarPaso(1)">
                  <i class="bi bi-arrow-left me-2"></i>
                  Regresar
                </button>
                <button type="button" class="btn btn-primary btn-lg px-5"
                        (click)="cambiarPaso(3)">
                  Continuar
                  <i class="bi bi-arrow-right ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Paso 3: Confirmar -->
          <div *ngIf="currentStep === 3" class="step-content animate__animated animate__fadeIn">
            <h5 class="step-title mb-4 pb-2 border-bottom">
              <i class="bi bi-clipboard-check text-primary me-2"></i>
              Confirmación de Datos
            </h5>

            <div class="alert alert-success border-0 bg-success-subtle mb-5">
              <div class="d-flex align-items-center">
                <i class="bi bi-check-circle-fill text-success fs-4 me-3"></i>
                <div>
                  <h6 class="alert-heading mb-1">¡Revisión final!</h6>
                  <p class="mb-0">Verifique que toda la información sea correcta antes de guardar.</p>
                </div>
              </div>
            </div>

            <!-- Resumen en tarjetas -->
            <div class="row g-4 mb-5">
              <!-- Información Principal -->
              <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0 fw-bold text-primary">
                      <i class="bi bi-card-checklist me-2"></i>
                      Información Principal
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Cliente</small>
                          <p class="fw-medium mb-0">{{ clienteNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Área</small>
                          <p class="fw-medium mb-0">{{ areaNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Proyecto</small>
                          <p class="fw-medium mb-0">{{ proyectoNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Fase</small>
                          <p class="fw-medium mb-0">{{ faseNombre || '—' }}</p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Site</small>
                          <p class="fw-medium mb-0">{{ siteNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Región</small>
                          <p class="fw-medium mb-0">{{ regionNombre || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">Fecha Apertura</small>
                          <p class="fw-medium mb-0">{{ fechaAperturaFormatted || '—' }}</p>
                        </div>
                        <div class="mb-3">
                          <small class="text-muted d-block mb-1">OT Anterior</small>
                          <p class="fw-medium mb-0">{{ form.value.idOtsAnterior || 'No especificada (opcional)' }}</p>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4">
                      <small class="text-muted d-block mb-1">Descripción</small>
                      <div class="bg-light p-3 rounded border">
                        <p class="mb-0 text-muted">{{ form.value.descripcion || 'Descripción automática' }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Responsables -->
              <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white border-bottom">
                    <h6 class="mb-0 fw-bold text-primary">
                      <i class="bi bi-people me-2"></i>
                      Responsables
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Jefatura Cliente</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('jefaturaCliente') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Analista Cliente</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('analistaCliente') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Coordinador TI/CW</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('coordinadorTiCw') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Jefatura Responsable</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('jefaturaResponsable') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Liquidador</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('liquidador') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Ejecutante</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('ejecutante') || '—' }}
                      </p>
                    </div>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-1">Analista Contable</small>
                      <p class="fw-medium mb-0 small">
                        {{ getResponsableNombre('analistaContable') || '—' }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones finales -->
            <div class="step-actions mt-5 pt-4 border-top">
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary btn-lg px-4"
                        (click)="cambiarPaso(2)">
                  <i class="bi bi-arrow-left me-2"></i>
                  Regresar
                </button>

                <div class="d-flex gap-3">
                  <button type="button" class="btn btn-outline-danger btn-lg px-4"
                          (click)="onCancel()">
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-success btn-lg px-5 shadow-sm"
                          [disabled]="loading || form.invalid">
                    <ng-container *ngIf="!loading">
                      <i class="bi me-2" [ngClass]="isEditMode ? 'bi-save' : 'bi-plus-circle'"></i>
                      {{ isEditMode ? 'Guardar Cambios' : 'Crear OT' }}
                    </ng-container>
                    <ng-container *ngIf="loading">
                      <span class="spinner-border spinner-border-sm me-2"></span>
                      {{ isEditMode ? 'Guardando...' : 'Creando...' }}
                    </ng-container>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-footer bg-light border-top p-3 text-center text-muted small">
      <i class="bi bi-shield-lock me-1"></i>
      <span class="text-danger">*</span> Todos los campos son obligatorios •
      Único campo opcional: OT Anterior
    </div>
  </ng-container>
</div>
