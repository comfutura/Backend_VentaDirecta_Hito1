<!-- ots.component.html -->
<div class="ots-container">
  <!-- Header con acciones -->
  <div class="ots-header">
    <div class="header-content">
      <div class="title-section">
        <h1><i class="bi bi-list-task"></i> Órdenes de Trabajo</h1>
        <p class="text-muted">Gestión completa de OTs</p>
      </div>

      <div class="action-buttons">
        <!-- Exportación dropdown -->
        <div class="dropdown" ngbDropdown>
          <button class="btn btn-success btn-lg" ngbDropdownToggle>
            <i class="bi bi-download"></i> Exportar
          </button>
          <div class="dropdown-menu" ngbDropdownMenu>
            <button class="dropdown-item" (click)="openExportModal()">
              <i class="bi bi-gear"></i> Exportación avanzada
            </button>
            <button class="dropdown-item" (click)="exportSelectedOts()" [disabled]="selectedCount === 0">
              <i class="bi bi-check-circle"></i> Exportar seleccionadas ({{selectedCount}})
            </button>
            <button class="dropdown-item" (click)="exportAllOts()">
              <i class="bi bi-download"></i> Exportar todas
            </button>
          </div>
        </div>

        <button class="btn btn-primary btn-lg" (click)="openImportModal()">
          <i class="bi bi-upload"></i> Importar
        </button>

        <button class="btn btn-primary btn-lg" (click)="openCreateModal()">
          <i class="bi bi-plus-lg"></i> Nueva OT
        </button>
      </div>
    </div>

    <!-- Filtros rápidos -->
    <div class="filters-section">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" [(ngModel)]="searchText"
               (keyup.enter)="onSearch()"
               placeholder="Buscar OTs...">
        <button class="btn btn-outline-secondary" (click)="onSearch()">
          Buscar
        </button>
      </div>

      <div class="quick-filters">
        <select class="form-select" [(ngModel)]="estadoFilter" (change)="onSearch()">
          <option value="">Todos los estados</option>
          <option value="ASIGNACION">Asignación</option>
          <option value="EN PROCESO">En proceso</option>
          <option value="FINALIZADA">Finalizada</option>
          <option value="CANCELADA">Cancelada</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Tabla principal -->
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th width="50">
            <input type="checkbox" [checked]="selectAllChecked" (change)="toggleSelectAll($event)">
          </th>
          <th>OT</th>
          <th>Descripción</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Site</th>
          <th>Fecha</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ot of ots" [class.selected]="selectedOts.has(ot.idOts!)">
          <td>
            <input type="checkbox" [checked]="selectedOts.has(ot.idOts!)"
                   (change)="toggleSelectOt(ot)">
          </td>
          <td>
            <strong class="text-primary">#{{ot.ot}}</strong>
          </td>
          <td>{{ot.descripcion || '—'}}</td>
          <td>{{ot.clienteNombre || '—'}}</td>
          <td>
            <span class="badge" [ngClass]="getEstadoClass(ot.estadoOt)">
              {{ot.estadoOt || '—'}}
            </span>
          </td>
          <td>{{ot.siteNombre || '—'}}</td>
          <td>{{ot.fechaApertura | date:'dd/MM/yyyy'}}</td>
          <td class="text-end">
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-info" (click)="openViewModal(ot)">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary" (click)="openEditModal(ot)">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm"
                      [ngClass]="ot.activo ? 'btn-outline-danger' : 'btn-outline-success'"
                      (click)="toggleEstado(ot)">
                <i class="bi" [ngClass]="ot.activo ? 'bi-toggle-off' : 'bi-toggle-on'"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-2">Cargando OTs...</p>
  </div>

  <!-- Paginación -->
  <div *ngIf="!loading && totalPages > 0" class="pagination-section">
    <div class="pagination-info">
      Mostrando {{(currentPage * pageSize) + 1}} -
      {{Math.min((currentPage + 1) * pageSize, totalElements)}} de {{totalElements}}
    </div>

    <nav>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 0">
          <button class="page-link" (click)="goToPage(0)">
            <i class="bi bi-chevron-double-left"></i>
          </button>
        </li>

        <li class="page-item" [class.disabled]="currentPage === 0">
          <button class="page-link" (click)="goToPage(currentPage - 1)">
            <i class="bi bi-chevron-left"></i>
          </button>
        </li>

        <li *ngFor="let p of visiblePages" class="page-item" [class.active]="p === currentPage">
          <button class="page-link" (click)="goToPage(p)">{{p + 1}}</button>
        </li>

        <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
          <button class="page-link" (click)="goToPage(currentPage + 1)">
            <i class="bi bi-chevron-right"></i>
          </button>
        </li>

        <li class="page-item" [class.disabled]="currentPage >= totalPages - 1">
          <button class="page-link" (click)="goToPage(totalPages - 1)">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </li>
      </ul>
    </nav>

    <div class="page-size-selector">
      <select class="form-select" [(ngModel)]="pageSize" (change)="changePageSize(pageSize)">
        <option [value]="10">10 por página</option>
        <option [value]="20">20 por página</option>
        <option [value]="50">50 por página</option>
        <option [value]="100">100 por página</option>
      </select>
    </div>
  </div>
</div>

<!-- Modal de Exportación -->
<ng-template #exportModal>
  <div class="modal-content">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title">
        <i class="bi bi-download me-2"></i>Exportación de OTs
      </h5>
      <button type="button" class="btn-close btn-close-white"
              (click)="closeAllModals()"></button>
    </div>

    <div class="modal-body">
      <div class="export-options">
        <!-- Opción 1: Seleccionadas -->
        <div class="form-check mb-4">
          <input class="form-check-input" type="radio"
                 id="exportSelected" [(ngModel)]="exportFiltroActivo" [value]="true">
          <label class="form-check-label" for="exportSelected">
            <strong>Exportar seleccionadas</strong>
            <small class="d-block text-muted">
              {{selectedCount}} OTs seleccionadas
            </small>
          </label>
        </div>

        <!-- Opción 2: Todas -->
        <div class="form-check mb-4">
          <input class="form-check-input" type="radio"
                 id="exportAll" [(ngModel)]="exportFiltroActivo" [value]="false">
          <label class="form-check-label" for="exportAll">
            <strong>Exportar todas</strong>
            <small class="d-block text-muted">
              {{totalElements}} OTs en total
            </small>
          </label>
        </div>

        <!-- Filtros adicionales -->
        <div class="mb-3">
          <label class="form-label">Filtrar por texto:</label>
          <input type="text" class="form-control"
                 [(ngModel)]="exportFiltroText"
                 [disabled]="exportFiltroActivo">
        </div>

        <div class="row mb-3">
          <div class="col">
            <label class="form-label">Fecha desde:</label>
            <input type="date" class="form-control" [(ngModel)]="exportFechaDesde"
                   [disabled]="exportFiltroActivo">
          </div>
          <div class="col">
            <label class="form-label">Fecha hasta:</label>
            <input type="date" class="form-control" [(ngModel)]="exportFechaHasta"
                   [disabled]="exportFiltroActivo">
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary"
              (click)="closeAllModals()">Cancelar</button>
      <button type="button" class="btn btn-success"
              (click)="export()">
        <i class="bi bi-download me-2"></i>Exportar
      </button>
    </div>
  </div>
</ng-template>

<!-- Modal de Importación -->
<ng-template #importModal>
  <div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">
        <i class="bi bi-upload me-2"></i>Importar OTs desde Excel
      </h5>
      <button type="button" class="btn-close btn-close-white"
              (click)="closeAllModals()"></button>
    </div>

    <div class="modal-body">
      <!-- Paso 1: Seleccionar archivo -->
      <div *ngIf="importStep === 1" class="text-center">
        <div class="drop-zone"
             (click)="fileInput.click()"
             (dragover)="onDragOver($event)"
             (drop)="onFileDrop($event)">
          <input #fileInput type="file" hidden accept=".xlsx" (change)="onFileSelected($event)">

          <i class="bi bi-cloud-upload display-1 text-muted"></i>
          <h5 class="mt-3">Arrastra o haz clic para subir</h5>
          <p class="text-muted">Archivos Excel (.xlsx) hasta 10MB</p>

          <div *ngIf="importFile" class="file-info alert alert-success mt-3">
            <i class="bi bi-file-excel"></i> {{importFile.name}}
            <small>({{importFile.size | fileSize}})</small>
          </div>
        </div>

        <div class="mt-4">
          <button class="btn btn-outline-primary" (click)="downloadTemplate()">
            <i class="bi bi-download me-2"></i>Descargar plantilla
          </button>
        </div>
      </div>

      <!-- Paso 2: Opciones -->
      <div *ngIf="importStep === 2">
        <div class="mb-4">
          <label class="form-label">Modo de importación:</label>
          <select class="form-select" [(ngModel)]="importMode">
            <option value="normal">Normal (hasta 50 registros)</option>
            <option value="masivo">Masivo (más de 50 registros)</option>
          </select>
        </div>

        <div *ngIf="importMode === 'masivo'" class="alert alert-warning">
          <i class="bi bi-info-circle me-2"></i>
          El modo masivo procesa en segundo plano y puede tomar varios minutos.
        </div>
      </div>

      <!-- Paso 3: Resultados -->
      <div *ngIf="importStep === 3 && importResult" class="text-center">
        <i class="bi bi-check-circle-fill display-1 text-success"></i>
        <h4 class="mt-3">Importación completada</h4>

        <div class="row mt-4">
          <div class="col">
            <div class="card border-success">
              <div class="card-body">
                <h2 class="text-success">{{importResult.exitosos}}</h2>
                <p class="text-success">Exitosos</p>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card border-danger">
              <div class="card-body">
                <h2 class="text-danger">{{importResult.fallidos}}</h2>
                <p class="text-danger">Fallidos</p>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="importResult.fallidos > 0" class="mt-4">
          <h6>Errores:</h6>
          <div class="alert alert-danger text-start">
            <div *ngFor="let error of importResult.registrosConError">
              <strong>Fila {{error.filaExcel}}:</strong> {{error.mensajeError}}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button *ngIf="importStep === 1" type="button" class="btn btn-secondary"
              (click)="closeAllModals()">Cancelar</button>

      <button *ngIf="importStep === 1 && importFile" type="button" class="btn btn-primary"
              (click)="importStep = 2">Siguiente</button>

      <button *ngIf="importStep === 2" type="button" class="btn btn-secondary"
              (click)="importStep = 1">Atrás</button>

      <button *ngIf="importStep === 2" type="button" class="btn btn-success"
              (click)="startImport()" [disabled]="importing">
        <i *ngIf="importing" class="bi bi-hourglass-split me-2"></i>
        {{importing ? 'Importando...' : 'Iniciar importación'}}
      </button>

      <button *ngIf="importStep === 3" type="button" class="btn btn-primary"
              (click)="closeAllModals()">Finalizar</button>
    </div>
  </div>
</ng-template>
